<!-- COMMON TAGS -->
<meta charset="utf-8">
<title>image-splitter</title>
<!-- Search Engine -->
<meta name="description" content="splits images!">
<!-- Schema.org for Google -->
<meta itemprop="name" content="image-splitter">
<meta itemprop="description" content="splits images!">
<!-- Open Graph general (Facebook, Pinterest & Google+) -->
<meta name="og:title" content="image-splitter">
<meta name="og:description" content="splits images!">
<meta name="og:url" content="http://ruyili.ca/image-splitter">
<meta name="og:site_name" content="image-splitter">
<meta name="og:locale" content="en_US">
<meta name="og:type" content="website">

<style> 
    input, canvas, textarea { 
        display: block; 
        margin: 10px;
    }

    a{
        font-size: 2rem;
    }
</style>

<form>
    <input type="file">
    size of each emoji in pixels
    <input type="number" value="128">
    <input type="submit" value="split">
</form>

if the preview looks weird, try zooming out
<div></div>
<canvas></canvas>

<a>download</a>
<button disabled>download (if the other one doesn't work)</button>
<p></p>

copy this to display the emojis after you've finished uploading them. this will be included in the zip file
<textarea readonly rows="50" cols="100"></textarea>

<script src="jszip.min.js"></script>
<script src="filesaver.js"></script>
<script>
    const $ = document.querySelector.bind(document); // i made jquery :poggers:
    const b = $('input[type="submit"]');
    const section = $('canvas');
    const ctx = section.getContext('2d');
    const txt = $('textarea');
    const previewDiv = $('div');

    const rm = (tag) => {
        for(el of document.querySelectorAll(tag)) el.parentNode.removeChild(el);
    }

    const toBlob = (d) => new Promise((res) => d.toBlob(res));

    let fn;

    $('form').onsubmit = (e) => {
        e.preventDefault();
        const file = URL.createObjectURL($('input[type="file"]').files[0]);
        const size = +$('input[type="number"]').value;
        b.value = "working...";

        rm('img'); rm('br'); rm('canvas');

        const img = new Image();
        img.src = file;
        img.onload = async () => {
            txt.value = '';
            section.width = section.height = size;

            const startTime = Date.now();
            const zip = new JSZip();
            b.value = "wait for it...";

            const w = Math.ceil(img.width/size);
            const h = Math.ceil(img.height/size);

            console.log(w, h, size);

            let str = ''
            
            for(let y = 0; y>-h; y--){
                for(let x = 0; x>-w; x--){
                    ctx.drawImage(img, x*size, y*size);
                    const blob = await toBlob(section);
                    zip.file(`${-x}_${-y}.png`, blob);
                    const preview = document.createElement('img');
                    preview.src = URL.createObjectURL(blob);
                    previewDiv.appendChild(preview);
                    ctx.clearRect(0, 0, size, size);
                    str += `:${-x}_${-y}:`;
                }
                previewDiv.appendChild(document.createElement('br'));
                str += '\r\n';
            }
            txt.value = str;
            zip.file('emojis.txt', str);
            const genZip = await zip.generateAsync({ type: 'blob' });
            $('p').innerHTML = `time taken: ${Date.now()-startTime}ms`;
            b.value = 'split';
            //$('a').href = 'data:application/zip;base64,' + b64;
            $('button').disabled = false;
            fn = () => saveAs(genZip, 'emojis.zip')
            $('a').href = 'javascript:fn()';
        }
    }

    $('button').onclick = () => fn();
</script>